#!/bin/sh -ex
# What to do for a release of a new version in Debian:
#- Get released tarball
cd "`dirname "$0"`"/..
uscan
dir="`mktemp -d`"
name="`cd .. && echo pioneers*orig.tar.gz`"
if [ -z "${name##*\**}" ] ; then
	# Not a new release, use the old one
	(cd "$dir" && apt-get source --download-only pioneers)
else
	cp ../pioneers*orig.tar.gz "$dir/"
fi
name="`cd "$dir" && echo pioneers*orig.tar.gz`"
tar -xzf - -C "$dir" < "$dir/$name"
pdir="`cd "$dir" && echo pioneers-[0-9]*`"

#- Copy debian directory from subversion
svn export debian "$dir/$pdir/debian"

cd "$dir/$pdir"

#- dch, mark bugs as closed
dch -i

#- pdebuild
pdebuild

#- read ../pioneers*diff.gz
vim ../pioneers*diff.gz

# remove changes file generated by pdebuild, so a new one is created
rm ../pioneers*changes

#- debuild
debuild -uc -us

# sign
cd ..
debsign -k627CCF95 *changes

#- install, test
sudo dpkg -i *deb
pioneers-server-console &
pioneersai &
pioneersai &
pioneersai &
pioneers

#- piuparts
piuparts *deb

#- upload
#- update subversion debian directory
#- svn copy https://pio.svn.sourceforge.net/svnroot/pio/trunk/pioneers/debian \
#  https://pio.svn.sourceforge.net/svnroot/pio/tags/debian-release-X.XX.XX-1 \
#  -m "tag debian release"
